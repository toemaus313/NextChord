default_platform(:android)

platform :android do
  desc "Build & upload a beta (test) Android appbundle to Google Play"
  lane :beta do |options|
    flutter_bump_version(
      bump_build: true,
      pubspec: "../pubspec.yaml"  # Correct parameter name to avoid being prompted
    )
    # 1. Build the appbundle using Flutter from the project root
    Dir.chdir("..") do
      sh "flutter pub get"
      sh "flutter build appbundle --release"
    end

    # 2. Path to the AAB generated by Flutter (absolute, based on project root)
    # __dir__  => /Users/.../NextChord/android/fastlane
    # project_root => /Users/.../NextChord
    project_root = File.expand_path("../..", __dir__)
    aab_path = File.join(project_root, "build/app/outputs/bundle/release/app-release.aab")

    unless File.exist?(aab_path)
      UI.user_error!("AAB not found at #{aab_path}. Did the Flutter build succeed?")
    end

    # 3. Upload to Google Play
    upload_to_play_store(
      aab: aab_path,
      track: options[:track] || "internal",  # "internal", "beta", "alpha", "production"
      release_status: options[:status] || "draft"  # Use "draft" for draft apps, "completed" for published apps
    )
  end
end
