# Fastlane configuration for NextChord iOS
# Run from the ios/ directory with: fastlane beta

default_platform(:ios)

platform :ios do
  desc "Build and upload a beta version to TestFlight"
  lane :beta do
    # 1. Build Flutter iOS app without codesign
    sh "cd .. && flutter pub get"
    sh "cd .. && flutter build ios --release --no-codesign"

    # 2. App Store Connect API key (your existing key)
    api_key = app_store_connect_api_key(
      key_id: "D28W2YBXS9",
      issuer_id: "a5176732-64f6-441d-8ed0-0db127470dda",
      key_filepath: "../AuthKeys/AuthKey_D28W2YBXS9.p8"
    )

    # 3. Bump build number in Xcode project
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )

    # 4. Archive + export IPA using Xcode workspace and automatic signing
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",                 # or "app-store-connect" if you prefer
      export_xcargs: "-allowProvisioningUpdates"  # lets Xcode create/download profiles
    )

    # 5. Get the IPA path produced by build_app
    ipa_path = lane_context[SharedValues::IPA_OUTPUT_PATH]

    # 6. Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      app_identifier: "us.antonovich.nextchord",
      skip_submission: true,                  # don't auto-submit for beta review
      skip_waiting_for_build_processing: false,
      distribute_external: false,             # internal only
      groups: ["Int"]                         # your internal TestFlight group
    )
  end
end
